/*
|--------------------------------------------------------------------------
| MarkdownPad2 编辑器导出 html 文件时自动生成左侧目录插件
|--------------------------------------------------------------------------
|
| 此插件用于将在 MarkdownPad2 编辑器中编辑的文档在转为 Html文件时自动生成左侧目录
| 目录生成时默认将第一个 h1 标签作为文档的题目，当检测到有多个 h1 标签时，
| 会将除了第一个 h1 外的所有 h1 标签自动转换为 h2 标签，其余标签自动向下转一级
| 功能：
| 1.根据 html文档中 h1~h6 标签自动生成对应的目录
| 2.自动生成目录编号，可选择是否显示目录编号
| 3.目录搜索功能，全文搜索使用浏览器自带的 Ctrl+F
| 4.提供三种目录样式，可自由选择
| 5.提供白天和夜间 2 种阅读模式
| 6.根据当前阅读位置，自动显示所在目录
| 7.一键展开收起目录列表
| 8.整个左侧栏目可展开和收起
|
| 作者: YXC (cayang512@163.com )
| GitHub https://github.com/cayxc
| Gitee https://gitee.com/yangxingcai
|
*/
window.onload=function(){function createContent(){let oldContent=document.body.innerHTML;document.body.innerHTML='';let leftBlock=document.createElement('div');let rigthBlock=document.createElement('div');leftBlock.id='left-container';rigthBlock.id='right-container';leftBlock.innerHTML='\n<div class="top-container">\n'+'        <i class="catalog-button iconfont icon-catalogOpen"></i>\n'+'        <div class="search-container">\n'+'            <input type="text" class="search" name="search" placeholder="输入关键字搜索 . . .">\n'+'            <i class="search-icon iconfont icon-cancel"></i>\n'+'        </div>\n'+'        <div class="search-result"></div>\n'+'    </div>\n'+'    <div id="list-container">\n'+'        <div class="list-wrapper">\n'+'        </div>\n'+'    </div>\n'+'    <div class="bottom-container">\n'+'        <div class="mode-container">\n'+'            <div class="mode">\n'+'                <i class="iconfont icon-sun"></i>\n'+'            </div>\n'+'            <div class="index">\n'+'                <i class="iconfont icon-indexA"></i>\n'+'            </div>\n'+'            <div class="structure">\n'+'                <i class="iconfont icon-process"></i>\n'+'                <ul class="structure-child">\n'+'                    <li>\n'+'                        <input type="radio" id="styleA" name="catalogStyle" value="1" checked="checked">\n'+'                        <label for="styleA">样式 A</label>\n'+'                    </li>\n'+'                    <li>\n'+'                        <input type="radio" id="styleB" value="2" name="catalogStyle">\n'+'                        <label for="styleB">样式 B</label>\n'+'                    </li>\n'+'                    <li>\n'+'                        <input type="radio" id="styleC" value="3" name="catalogStyle">\n'+'                        <label for="styleC">样式 C</label>\n'+'                    </li>\n'+'                </ul>\n'+'            </div>\n'+'            <div class="color" style="display: none;">\n'+'                <i class="iconfont icon-color"></i>\n'+'                <div class="color-child">\n'+'                    <span>自定义颜色</span>\n'+'                    <input type="color">\n'+'                </div>\n'+'            </div>\n'+'        </div>\n'+'    </div>\n'+'   <div id="switch-button">\n'+'   <i class="iconfont icon-arrLeft"></i>\n'+'   </div>\n';rigthBlock.innerHTML='\n<div id="content">\n'+oldContent+'\n</div>\n'+'</div>\n';document.body.appendChild(leftBlock);document.body.appendChild(rigthBlock);let msg='\n<p class="note-tips">\n'+' 提示：在生成目录时，当检测到有多个 h1 标签时，会将除了第一个 h1 标签外的所有 h1 标签自动转换为 h2 标签，其余标签自动向下转一级（h3 转为 h4，以此类推），'+' 此操作会影响目录的生成速度，推荐用一个 h1 标签作为文档标题，h2 作为一级标题。'+' 该插件仅在使用 MarkDownPad2 软件将 .md 导出为 .html 文件时生效，且不影响源文件。'+'<br/>如有问题请联系： cayang512@163.com&emsp;插件获取地址:&emsp;<a href="https://github.com/cayxc/MarkdownPad2AutoCatalog" target="_blank"> GitHub地址</a>&emsp;<a href="https://gitee.com/yangxingcai/markdownpad2-auto-catalog" target="_blank">Gitee地址</a></p>\n';noteTips('div',msg,'content');}function changeTag(){let h1Tag=document.querySelectorAll('h1');if(h1Tag.length>1){let otherTag=document.querySelectorAll('h2,h3,h4,h5');for(let i=1,len=h1Tag.length;i<len;i++){let newTag=document.createElement('h2');newTag.innerHTML=h1Tag[i].innerHTML;h1Tag[i].parentNode.replaceChild(newTag,h1Tag[i]);}for(let j=0,len=otherTag.length;j<len;j++){let tagName='h'+(parseInt(otherTag[j].nodeName.slice(1))+1);let newTag2=document.createElement(tagName);newTag2.innerHTML=otherTag[j].innerHTML;otherTag[j].parentNode.replaceChild(newTag2,otherTag[j]);}}}function getTagNumber(tag){if((typeof tag)!='object'){return'getTagNumber() 调用时参数类型错误，必须是一个h标签的对象集合！';}return Number(tag.nodeName.slice(1));}function findStrFre(str,char){if((typeof str)!=='string'||(typeof str)!=='string'){return'findStrFre() 调用时参数类型错误！';}let index=str.indexOf(char);let number=0;while(index!==-1){number++;index=str.indexOf(char,index+1);}return number;}function levelTagArr(level){if(level<1||level>5||(typeof level)!=='number'){return'levelTagArr() 调用时参数类型错误！';}let allTag=document.querySelectorAll('h2,h3,h4,h5,h6');let level1=[];let level2=[];let level3=[];let level4=[];let level5=[];for(let i=0,len=allTag.length;i<len;i++){let number=findStrFre(allTag[i].id,'.');switch(number){case 0:level1.push(allTag[i]);break;case 1:level2.push(allTag[i]);break;case 2:level3.push(allTag[i]);break;case 3:level4.push(allTag[i]);break;case 4:level5.push(allTag[i]);break;default:i++;}}switch(level){case 1:return level1;case 2:return level2;case 3:return level3;case 4:return level4;case 5:return level5;default:return;}}function childTagArr(tagObj){if((typeof tagObj)!=='object'){return'childTagArr() 调用时参数类型错误，必须是一个 h 标签的对象集合';}let result=[];let level=findStrFre(tagObj.id,'.')+1;if(level==5){result.push(tagObj);}else{let allChildTag=levelTagArr(level+1);let faTagId=tagObj.id.slice(6);for(let i=0,len=allChildTag.length;i<len;i++){let chTagId=allChildTag[i].id.slice(6,allChildTag[i].id.lastIndexOf('.'));if(chTagId==faTagId){result.push(allChildTag[i]);}}}return result;}function setLevelNumber(tag){if((typeof tag)!='object'){return'setLevelNumber() 调用时参数类型错误，必须是一个h标签的对象集合！';}let str=tag.id;if(str.lastIndexOf('.')==-1){let newValue=parseInt(str.slice(6))+1;return'level-'+newValue;}else{let lastIndex=str.lastIndexOf('.');let oldValue=str.slice(0,lastIndex);let newValue=parseInt(str.slice(lastIndex+1))+1;return oldValue+'.'+newValue;}}function setTagLevel(){changeTag();let allTag=document.querySelectorAll('h2,h3,h4,h5,h6');if(allTag.length==0){let msg='<p style="color:#cccccc;font-size:'+' 14px;text-align: center;">啊...<br/>文档中未发现 h2~h6 标签<br/>无法生成目录</p>';noteTips('div',msg,'list-container');return false;}else if(allTag.length==1){allTag[0].id='level-'+'1';}else if(allTag.length>1){allTag[0].id='level-'+'1';let result=getTagNumber(allTag[1])-getTagNumber(allTag[0]);if(result<=0){allTag[1].id=setLevelNumber(allTag[0]);}else{allTag[1].id=allTag[0].id+'.1';}}else{return false;}let tagLength=allTag.length-1;for(let i=2,len=tagLength;i<len;i++){let currentTagNumber=getTagNumber(allTag[i]);let prevTagNumber=getTagNumber(allTag[i-1]);if(currentTagNumber<prevTagNumber){for(let j=i-1;j>=0;j--){let status=getTagNumber(allTag[j])-currentTagNumber;if(status==1){if(j>0){if(getTagNumber(allTag[j-1])==currentTagNumber){allTag[i].id=setLevelNumber(allTag[j-1]);break;}}else{allTag[i].id=setLevelNumber(allTag[j]);break;}}if(status==0){allTag[i].id=setLevelNumber(allTag[j]);break;}}}if(currentTagNumber>prevTagNumber){allTag[i].id=allTag[i-1].id+'.1';}if(currentTagNumber==prevTagNumber){allTag[i].id=setLevelNumber(allTag[i-1]);}}let tagSet=document.querySelectorAll(allTag[tagLength-1].nodeName);allTag[tagLength-1].id=setLevelNumber(tagSet[tagSet.length-2]);}function creatCatalogue(){setTagLevel();let catalogueBlock=document.querySelector('.list-wrapper');let ulElement=document.createElement('ul');for(let j=1;j<=5;j++){let levelArr=levelTagArr(j);let levelLength=levelArr.length;if(levelLength==0){break;}if(j==1){for(let k=0,len=levelLength;k<len;k++){let liElement=document.createElement('li');liElement.innerHTML='\n<a href="#'+levelArr[k].id+'" class='+levelArr[k].id+'>\n'+'<p>'+levelArr[k].id.slice(6)+'</p>\n'+'<span>'+levelArr[k].innerText+'</span>'+'</a>\n';ulElement.appendChild(liElement);catalogueBlock.appendChild(ulElement);}}if(j>1){for(let n=0,len=levelLength;n<len;n++){let prevLevelArr=levelTagArr(j-1);for(let m=0,preLen=prevLevelArr.length;m<preLen;m++){let currentId=levelArr[n].id.slice(6,levelArr[n].id.lastIndexOf('.'));let prevId=prevLevelArr[m].id.slice(6);if(currentId==prevId){let className=prevLevelArr[m].id;let prevElement=document.getElementsByClassName(className)[0].parentNode;prevElement.setAttribute('class','parent-level');let liElement=document.createElement('li');liElement.innerHTML='\n<a href="#'+levelArr[n].id+'" class='+levelArr[n].id+'>\n'+'<p>'+levelArr[n].id.slice(6)+'</p>\n'+'<span>'+levelArr[n].innerText+'</span>'+'</a>\n';let currentUlElement=prevElement.querySelector('ul');if(currentUlElement!==null){currentUlElement.appendChild(liElement);}else{currentUlElement=document.createElement('ul');currentUlElement.setAttribute('class','js-open');currentUlElement.appendChild(liElement);prevElement.appendChild(currentUlElement);let parentStyle=document.createElement('i');parentStyle.setAttribute('class','iconfont icon-openA');prevElement.insertBefore(parentStyle,prevElement.childNodes[0]);}break;}}}}}}function noteTips(tag,msg,id){if((typeof tag)!=='string'||(typeof msg)!=='string'||(typeof id)!=='string'){return'noteTips() 调用时参数类型错误！';}let exp=document.createElement(tag);exp.innerHTML=msg;document.getElementById(id).appendChild(exp);}let isCreated=document.body.children[0].getAttribute('id');if(isCreated!='left-container'||isCreated==null){createContent();creatCatalogue();}let leftElement=document.querySelector('#left-container');let rightElement=document.querySelector('#right-container');let content=document.querySelector('#content');let topElement=document.querySelector('.top-container');let listElement=document.querySelector('.list-wrapper');let switchButton=document.querySelector('#switch-button');let switchListButton=document.querySelector('.catalog-button');let viewModeButton=document.querySelector('.mode');let allIcon=listElement.children[0].querySelectorAll('i');let allChildLevel=listElement.children[0].querySelectorAll('ul');let allCatalogElement=listElement.querySelectorAll('a');function switchCatalog(){let status=0;switchButton.onclick=function(){let browsertWidth=document.documentElement.clientWidth;if(status==1){this.children[0].setAttribute('class','iconfont icon-arrLeft');if(browsertWidth>750){leftElement.style.width='280px';}else{leftElement.style.width='60%';}leftElement.classList.remove('js-switch-button');rightElement.style.padding='15px 15px 0 295px';status=0;}else{this.children[0].setAttribute('class','iconfont icon-closeC');leftElement.style.width='0';leftElement.style.padding='0';leftElement.classList.add('js-switch-button');leftElement.classList.add('js-switch-button');rightElement.style.padding='15px 15px 0';status=1;}}}switchCatalog();function swicthCatalogList(){switchListButton.onclick=function(){let indexNumber=getStyleIndex();let status;let haveOpen=listElement.children[0].querySelector('.js-close');if(haveOpen){status=1;}else{status=0;}if(status==1){this.setAttribute('class','catalog-button iconfont icon-catalogOpen');for(let i=0,len=allIcon.length;i<len;i++){if(indexNumber==1){allIcon[i].setAttribute('class','iconfont icon-openA');}else if(indexNumber==2){allIcon[i].setAttribute('class','iconfont icon-openB');}else{allIcon[i].setAttribute('class','iconfont icon-openC');}}for(let j=0,chLen=allChildLevel.length;j<chLen;j++){allChildLevel[j].setAttribute('class','js-open');}}else{this.setAttribute('class','catalog-button iconfont icon-catalogClose');for(let i=0,allLen=allIcon.length;i<allLen;i++){if(indexNumber==1){allIcon[i].setAttribute('class','iconfont icon-closeA');}else if(indexNumber==2){allIcon[i].setAttribute('class','iconfont icon-closeB');}else{allIcon[i].setAttribute('class','iconfont icon-closeC');}}for(let j=0,allChLen=allChildLevel.length;j<allChLen;j++){allChildLevel[j].setAttribute('class','js-close');}}}}swicthCatalogList();function switchParentCatalog(){for(let i=0,len=allIcon.length;i<len;i++){allIcon[i].onclick=function(){let indexNumber=getStyleIndex();let closeClass='';let openClass='';if(indexNumber==1){closeClass='iconfont icon-closeA';openClass='iconfont icon-openA';}else if(indexNumber==2){closeClass='iconfont icon-closeB';openClass='iconfont icon-openB';}else{closeClass='iconfont icon-closeC';openClass='iconfont icon-openC';}let status=allIcon[i].nextElementSibling.nextElementSibling.getAttribute('class');if(status=='js-open'){allIcon[i].setAttribute('class',closeClass);allIcon[i].nextElementSibling.nextElementSibling.setAttribute('class','js-close');}else{allIcon[i].setAttribute('class',openClass);allIcon[i].nextElementSibling.nextElementSibling.setAttribute('class','js-open');}let isAllClose=listElement.querySelector('.js-open');if(!isAllClose){topElement.children[0].setAttribute('class','catalog-button iconfont icon-catalogClose');}let isAllOpen=listElement.querySelector('.js-close');if(!isAllOpen){topElement.children[0].setAttribute('class','catalog-button iconfont icon-catalogOpen');}}}}switchParentCatalog();function changeParentColor(itemLi){if((typeof itemLi)!=='object'){return'changeParentColor() 参数必须是一个标签对象！';}itemLi.classList.add('js-active');if(itemLi.parentElement.parentElement.nodeName=='LI'){changeParentColor(itemLi.parentElement.parentElement);}else{return;}}function singLeCatalogClick(){listElement.querySelector('li').classList.add('js-active');for(let i=0,len=allCatalogElement.length;i<len;i++){allCatalogElement[i].onclick=function(){let oldActiveElement=listElement.querySelectorAll('.js-active');for(let j=0,oldLen=oldActiveElement.length;j<oldLen;j++){oldActiveElement[j].classList.remove('js-active');}allCatalogElement[i].parentElement.classList.add('js-active');changeParentColor(allCatalogElement[i].parentElement);}}}singLeCatalogClick();function catalogTrack(){let allTag=content.querySelectorAll('h2,h3,h4,h5,h6');let allTtitleDistance=[];for(let i=0,len=allTag.length;i<len;i++){allTtitleDistance.push(allTag[i].offsetTop);}rightElement.onscroll=function(e){e=e||window.event;let top=eval(rightElement.scrollTop+50);for(let i=0,len=allTtitleDistance.length;i<len;i++){if(top>=allTtitleDistance[i]){let oldActiveElement=listElement.querySelectorAll('.js-active');for(let j=0;j<oldActiveElement.length;j++){oldActiveElement[j].classList.remove('js-active');}allCatalogElement[i].parentElement.classList.add('js-active');changeParentColor(allCatalogElement[i].parentElement);}}}}catalogTrack();function nightView(){let status=0;viewModeButton.onclick=function(){if(status==0){viewModeButton.children[0].setAttribute('class','iconfont icon-night');document.body.classList.add('js-night-view');status=1;leftElement.style.borderColor='#3E3D42';}else{viewModeButton.children[0].setAttribute('class','iconfont icon-sun');document.body.classList.remove('js-night-view');status=0;leftElement.style.borderColor='#ccc';}}let leftBdColor=leftElement.getAttribute('border-color');switchButton.onmouseover=function(){leftElement.style.borderColor='#3cae7c';}switchButton.onmouseout=function(){leftElement.style.borderColor=leftBdColor;}}nightView();let showIndex=document.querySelector('.index');let allIndex=listElement.querySelectorAll('p');function showCatalogIndex(){let status=0;showIndex.onclick=function(){if(status==1){this.children[0].setAttribute('class','iconfont icon-indexA');for(let i=0,len=allIndex.length;i<len;i++){allIndex[i].classList.remove('js-close');}status=0;}else{this.children[0].setAttribute('class','iconfont icon-indexB');for(let i=0,len=allIndex.length;i<len;i++){allIndex[i].classList.add('js-close');}status=1;}}}showCatalogIndex();function catalogStyle(){let allStyle=document.querySelector('.structure-child').querySelectorAll('li');let allRadio=document.querySelector('.structure-child').querySelectorAll('input');for(let i=0,len1=allStyle.length;i<len1;i++){allStyle[i].onclick=function(){for(let j=0,len2=allIcon.length;j<len2;j++){let isClose=allIcon[j].nextElementSibling.nextElementSibling.getAttribute('class');if(i==0){if(isClose=='js-close'){allIcon[j].setAttribute('class','iconfont icon-closeA');}else{allIcon[j].setAttribute('class','iconfont icon-openA');}}else if(i==1){if(isClose=='js-close'){allIcon[j].setAttribute('class','iconfont icon-closeB');}else{allIcon[j].setAttribute('class','iconfont icon-openB');}}else{if(isClose=='js-close'){allIcon[j].setAttribute('class','iconfont icon-closeC');}else{allIcon[j].setAttribute('class','iconfont icon-openC');}}}for(let k=0,len3=allRadio.length;k<len3;k++){if((allRadio[k].getAttribute('checked'))=='checked'){allRadio[k].removeAttribute('checked');}}allStyle[i].children[0].setAttribute('checked','checked');}}}catalogStyle();function getStyleIndex(){let indexNumber;let allStyleNumber=document.getElementsByName('catalogStyle');for(let j=0,len=allStyleNumber.length;j<len;j++){if((allStyleNumber[j].getAttribute('checked'))=='checked'){indexNumber=allStyleNumber[j].value;break;}}return indexNumber;}function comparison(value){if((typeof value)!='string'){return'comparison() 参数必须是一个字符串';}value=value.toLowerCase();let result='';for(let i=0,len=allCatalogElement.length;i<len;i++){let text=allCatalogElement[i].innerText.replace(/\s+/g,'');if(text.toLowerCase().indexOf(value)!=-1){let href=allCatalogElement[i].getAttribute('href');result+='\n<a href="'+href+'">'+allCatalogElement[i].innerText+'</a>\n';}}if(result==''){result='\n<i class="iconfont icon-search"></i>\n<span>目录中暂无相关搜索结果</span>\n<span>试试 Ctrl+F  在全文档搜索</span>\n';}return result;}comparison();function searchCatalog(){let searchElement=document.querySelector('.search');let searchResultElement=document.querySelector('.search-result');let searchIconElement=searchElement.nextElementSibling;searchElement.onfocus=function(){searchElement.onkeyup=function(){let searchNewValue=(searchElement.value).replace(/\s+/g,'');if(searchNewValue){searchResultElement.style.display='block';searchIconElement.style.display='block';let result=comparison(searchNewValue);searchResultElement.innerHTML=result;let allSearch=searchResultElement.querySelectorAll('a');for(let j=0,len=allSearch.length;j<len;j++){allSearch[j].onclick=function(){allSearch[j].classList.add('js-active');}}}else{searchResultElement.style.display='none';searchIconElement.style.display='none';}}}searchIconElement.onclick=function(){this.style.display='none';searchResultElement.style.display='none';searchElement.value='';}}searchCatalog();}


